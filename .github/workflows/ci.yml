name: CI

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Parse all Turtle files with rdflib
        run: |
          python - <<'PY'
          import sys, pathlib
          from rdflib import Graph
          root = pathlib.Path(".")
          ttl_files = list(root.rglob("*.ttl"))
          failed = []
          for f in ttl_files:
              try:
                  g = Graph()
                  g.parse(f.as_posix(), format="turtle")
              except Exception as e:
                  failed.append((f, str(e)))
          if failed:
              print("Failed to parse the following TTL files:")
              for f, err in failed:
                  print(f" - {f}: {err}")
              sys.exit(1)
          print("All TTL files parsed OK")
          PY

      - name: Run SHACL (valid dataset)
        run: |
          pyshacl -s shapes/p6-shacl.ttl -i turtle -m -f human examples/sample-p6.ttl

      - name: Validate manifest.json
        run: |
          python scripts/validate-manifest.py

  negative-shacl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run SHACL (invalid dataset should fail)
        run: |
          set +e
          pyshacl -s shapes/p6-shacl.ttl -i turtle -m -f human examples/sample-p6-invalid.ttl
          status=$?
          # Expect non-zero exit from pyshacl; invert for CI success
          if [ "$status" -eq 0 ]; then
            echo "Expected SHACL validation to fail on invalid dataset, but it passed."
            exit 1
          else
            echo "Invalid dataset correctly failed SHACL validation."
            exit 0
          fi



